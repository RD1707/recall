<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete seu Perfil - Recall</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="auth-layout">
        <div class="auth-promo-panel">
            <div class="promo-content">
                <a href="index.html" class="promo-logo">Recall</a>
                <h2 class="promo-title">Bem-vindo ao Recall!</h2>
                <p class="promo-subtitle">Complete seu perfil para começar a usar nossa plataforma de flashcards inteligentes.</p>
                <div class="promo-illustration">
                    <svg viewBox="0 0 495 454" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="145.5" y="52.5" width="349" height="240" rx="17.5" fill="#4F46E5" fill-opacity="0.1"
                            stroke="#4F46E5" stroke-opacity="0.2" stroke-width="3" />
                        <rect x="75.5" y="99.5" width="349" height="240" rx="17.5" fill="#4F46E5" fill-opacity="0.2"
                            stroke="#4F46E5" stroke-opacity="0.3" stroke-width="3" />
                        <g filter="url(#filter0_d_1_12)">
                            <rect x="5" y="147" width="349" height="240" rx="18" fill="white" />
                            <rect x="6.5" y="148.5" width="346" height="237" rx="16.5" stroke="#4F46E5"
                                stroke-width="3" />
                        </g>
                        <rect x="42" y="196" width="188" height="14" rx="7" fill="#CBD5E0" />
                        <rect x="42" y="238" width="280" height="9" rx="4.5" fill="#E2E8F0" />
                        <rect x="42" y="257" width="280" height="9" rx="4.5" fill="#E2E8F0" />
                        <rect x="42" y="276" width="211" height="9" rx="4.5" fill="#E2E8F0" />
                        <defs>
                            <filter id="filter0_d_1_12" x="0" y="147" width="359" height="250"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dy="5" />
                                <feGaussianBlur stdDeviation="2.5" />
                                <feComposite in2="hardAlpha" operator="out" />
                                <feColorMatrix type="matrix"
                                    values="0 0 0 0 0.309804 0 0 0 0 0.27451 0 0 0 0 0.898039 0 0 0 0.1 0" />
                                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1_12" />
                                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1_12"
                                    result="shape" />
                            </filter>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>

        <div class="auth-form-panel">
            <div class="form-container">
                <div class="form-header">
                    <h1>Complete seu Perfil</h1>
                    <p>Precisamos de algumas informações para finalizar sua conta</p>
                </div>

                <div class="user-info" id="user-info" style="display: none;">
                    <div class="user-avatar">
                        <img id="user-avatar" src="" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;">
                    </div>
                    <p>Conectado como: <strong id="user-email"></strong></p>
                </div>

                <form id="complete-profile-form" novalidate>
                    <div class="form-group">
                        <label for="full-name">Nome Completo</label>
                        <div class="input-group">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <input class="form-control" type="text" id="full-name" placeholder="Seu nome completo" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="username">Nome de Usuário</label>
                        <div class="input-group">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <input class="form-control" type="text" id="username" placeholder="Nome de exibição"
                                pattern="^[a-zA-Z0-9_]+$" title="Use apenas letras, números e underscore"
                                required>
                        </div>
                        <small class="help-text">Use apenas letras, números e underscore (3-20 caracteres)</small>
                    </div>

                    <p id="error-message" class="error-message"></p>

                    <button type="submit" id="complete-profile-btn" class="btn btn-primary btn-full">
                        Finalizar Cadastro
                    </button>
                </form>

                <div class="toggle-panel">
                    <p><a href="login.html" class="back-to-login">Voltar para o login</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('complete-profile-form');
            const fullNameInput = document.getElementById('full-name');
            const usernameInput = document.getElementById('username');
            const submitBtn = document.getElementById('complete-profile-btn');
            const userInfo = document.getElementById('user-info');
            const userEmail = document.getElementById('user-email');
            const userAvatar = document.getElementById('user-avatar');

            // Carregar dados temporários do Google
            const tempData = sessionStorage.getItem('google_temp_data');
            if (!tempData) {
                showToast('Sessão expirada. Faça login novamente.', 'error');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            const googleData = JSON.parse(tempData);
            
            // Preencher campos com dados do Google
            fullNameInput.value = googleData.fullName || '';
            userEmail.textContent = googleData.email;
            
            if (googleData.avatarUrl) {
                userAvatar.src = googleData.avatarUrl;
                userInfo.style.display = 'block';
            }

            // Gerar sugestão de username baseado no nome/email
            if (googleData.fullName) {
                const suggestion = googleData.fullName
                    .toLowerCase()
                    .replace(/[^a-z0-9]/g, '')
                    .substring(0, 15);
                usernameInput.placeholder = `Ex: ${suggestion}`;
            }

            // Funções para mostrar erros de campo (reutilizadas do auth.js)
            function showFieldError(fieldName, errorMessage) {
                const field = document.getElementById(fieldName === 'full_name' ? 'full-name' : fieldName);
                if (field) {
                    field.classList.add('error');
                    
                    let errorElement = field.parentNode.parentNode.querySelector('.field-error');
                    if (!errorElement) {
                        errorElement = document.createElement('div');
                        errorElement.className = 'field-error';
                        field.parentNode.parentNode.appendChild(errorElement);
                    }
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                }
            }

            function clearFieldErrors() {
                const inputs = document.querySelectorAll('.form-control');
                inputs.forEach(input => input.classList.remove('error'));
                
                const errorElements = document.querySelectorAll('.field-error');
                errorElements.forEach(element => element.remove());
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fullName = fullNameInput.value.trim();
                const username = usernameInput.value.trim();

                // Validações
                if (!fullName || fullName.length < 3) {
                    showToast('Nome completo deve ter no mínimo 3 caracteres.', 'error');
                    return;
                }

                if (!username || username.length < 3 || username.length > 20) {
                    showToast('Nome de usuário deve ter entre 3 e 20 caracteres.', 'error');
                    return;
                }

                const usernameRegex = /^[a-zA-Z0-9_]+$/;
                if (!usernameRegex.test(username)) {
                    showToast('Nome de usuário inválido. Use apenas letras, números e underscore.', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Finalizando...';

                try {
                    const { data: { session } } = await _supabase.auth.getSession();
                    
                    const response = await fetch('/api/auth/complete-google-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session?.access_token}`
                        },
                        body: JSON.stringify({
                            userId: googleData.userId,
                            fullName: fullName,
                            username: username,
                            email: googleData.email,
                            avatarUrl: googleData.avatarUrl
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        clearFieldErrors();
                        
                        if (data.type === 'FIELD_ERROR' && data.field) {
                            showFieldError(data.field, data.error);
                        } else {
                            showToast(data.error || 'Erro ao completar perfil', 'error');
                        }
                    } else {
                        // Limpar dados temporários
                        sessionStorage.removeItem('google_temp_data');
                        
                        showToast('Perfil completado com sucesso!', 'success');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1000);
                    }

                } catch (error) {
                    console.error('Erro:', error);
                    showToast('Erro de conexão. Tente novamente.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Finalizar Cadastro';
                }
            });
        });
    </script>
</body>
</html>